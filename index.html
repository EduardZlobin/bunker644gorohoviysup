<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DODOM1 B1STRO | GLOBAL LINK ACTIVE</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root {
            --bg-color: #050505;
            --panel-bg: #0f0f0f;
            --border-color: #333;
            --text-main: #b0b0b0;
            --text-bright: #e0e0e0;
            --accent-red: #8a0000;
            --accent-red-bright: #ff0000;
            --accent-yellow: #d4a017;
            --terminal-font: 'Courier New', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--terminal-font);
            line-height: 1.5;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        body::after {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255,0,0,0.06), rgba(0,255,0,0.02), rgba(0,0,255,0.06));
            background-size: 100% 2px, 3px 100%; pointer-events: none; z-index: 9999;
        }

        @keyframes earthquake { 0% { transform: translate(1px, 1px); } 20% { transform: translate(-3px, 0px); } 40% { transform: translate(1px, -1px); } 60% { transform: translate(-3px, 1px); } 80% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -2px); } }
        @keyframes panic-blink { 0% { background-color: #000; } 50% { background-color: #300; } 100% { background-color: #000; } }

        body.doomsday-active { animation: earthquake 0.3s infinite; }
        body.doomsday-active header { animation: panic-blink 0.5s infinite; border-bottom: 5px solid red; }

        #lockdown-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 5000;
            justify-content: center; align-items: center; flex-direction: column; text-align: center;
        }
        .denied-text {
            color: red; font-size: 5rem; font-weight: bold; border: 10px solid red; padding: 20px;
            transform: rotate(-15deg); text-shadow: 0 0 20px red; background: #000;
        }

        header {
            background-color: #000; border-bottom: 2px solid var(--accent-red);
            padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;
            position: sticky; top: 0; z-index: 1000;
        }

        .logo { font-weight: bold; font-size: 1.4rem; color: var(--accent-red-bright); letter-spacing: 2px; text-transform: uppercase; }
        nav ul { display: flex; list-style: none; gap: 10px; }
        nav button {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-main);
            padding: 8px 15px; cursor: pointer; font-family: inherit; text-transform: uppercase; transition: 0.2s;
        }
        nav button:hover, nav button.active { border-color: var(--accent-red-bright); color: var(--accent-red-bright); }

        main { max-width: 900px; margin: 30px auto; padding: 20px; }
        .page { display: none; }
        .page.active { display: block; animation: flickIn 0.3s ease-out; }
        @keyframes flickIn { 0% { opacity: 0; } 100% { opacity: 1; } }

        h1 { color: var(--accent-red-bright); text-align: center; border-bottom: 1px dashed var(--accent-red); padding-bottom: 10px; margin-bottom: 20px; }
        h2, h3 { color: var(--text-bright); margin-top: 20px; margin-bottom: 10px; text-transform: uppercase; }

        .countdown-box {
            background: #000; border: 4px double var(--accent-red);
            color: var(--accent-red-bright); font-size: 2.5rem; text-align: center;
            padding: 20px; margin-bottom: 10px; text-shadow: 0 0 15px var(--accent-red);
        }

        .threat-container { margin: 20px 0; border: 1px solid #333; background: #000; padding: 10px; }
        .threat-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.8rem; color: var(--accent-yellow); }
        .meter-track { width: 100%; height: 30px; background: #111; border: 1px solid #444; position: relative; overflow: hidden; }
        .meter-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #330000, #ff0000); transition: width 0.5s; box-shadow: 0 0 20px #ff0000; }
        .meter-scan { position: absolute; top:0; bottom:0; width: 5px; background: rgba(255,255,255,0.5); animation: scan 2s infinite linear; }
        @keyframes scan { from { left: -10%; } to { left: 110%; } }

        .cyber-form { background: var(--panel-bg); border: 1px solid var(--border-color); padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--accent-yellow); }
        input, select, textarea { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 10px; font-family: inherit; }
        .radio-group { display: flex; gap: 20px; background: #000; padding: 10px; border: 1px solid #333; }
        .price-display { font-size: 1.5rem; text-align: right; color: var(--accent-red-bright); margin: 20px 0; border-top: 1px solid #333; padding-top: 10px; }

        button.action-btn {
            width: 100%; background: var(--accent-red); color: #fff; border: none; padding: 15px; font-size: 1.2rem; font-family: inherit; font-weight: bold; cursor: pointer; text-transform: uppercase; transition: 0.3s;
        }
        button.action-btn:hover { background: var(--accent-red-bright); box-shadow: 0 0 20px var(--accent-red); }

        .profile-card { background: #111; border: 2px solid var(--accent-yellow); padding: 20px; margin-bottom: 20px; }
        .data-row { display: flex; justify-content: space-between; border-bottom: 1px dotted #333; padding: 8px 0; }
        .data-row span:last-child { color: #fff; font-weight: bold; text-align: right; }

        .comments-section { margin-top: 20px; border-top: 2px solid #333; padding-top: 20px; max-height: 500px; overflow-y: auto; }
        .comment { background: #0a0a0a; border-left: 3px solid #333; padding: 10px; margin-bottom: 15px; animation: flickIn 0.3s; }
        .comment-header { font-size: 0.8rem; margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .user-badge { color: var(--accent-yellow); border: 1px solid var(--accent-red); padding: 0 5px; cursor: pointer; font-size: 0.75rem; }
        .user-badge:hover { background: var(--accent-red); color: #fff; }
        .comment-text { color: #ccc; word-wrap: break-word; }
        
        .status-online { color: #00ff00; text-shadow: 0 0 5px #00ff00; font-size: 0.8rem; float: right; margin-top: 5px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-box { background: #000; border: 2px solid var(--accent-red); padding: 20px; width: 90%; max-width: 500px; }

        #sound-toggle { position: fixed; bottom: 20px; right: 20px; z-index: 100; background: #000; border: 1px solid #555; color: #555; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; }
    </style>
</head>
<body onclick="initAudio()">

<header>
    <div class="logo">DODOM1 // BUNKER 644</div>
    <div class="status-online">СТАТУС СИСТЕМЫ: <span id="connectionStatus" style="color:yellow">ИНИЦИАЛИЗАЦИЯ...</span></div>
    <nav>
        <button onclick="nav('home')" class="active">ГЛАВНАЯ</button>
        <button onclick="nav('register')">ЗАЯВКА</button>
        <button onclick="nav('profile')">ЛИЧНЫЙ КАБИНЕТ</button>
        <button onclick="nav('comments')">КАНАЛ СВЯЗИ</button>
    </nav>
</header>

<main>
    <section id="home" class="page active">
        <h1>ВНИМАНИЕ: УГРОЗА "GOROHOVIYSUP"</h1>
        <p style="text-align: center; color: #888; margin-bottom: 10px;">ДАТА СЕРВЕРА: 18.12.2025</p>
        <div class="countdown-box" id="timer">--:--:--</div>
        <div class="threat-container">
            <div class="threat-label"><span>УРОВЕНЬ НАСЫЩЕНИЯ</span><span id="threat-percent">0%</span></div>
            <div class="meter-track"><div class="meter-fill" id="meter-fill"></div><div class="meter-scan"></div></div>
        </div>
        <div style="border: 1px solid var(--accent-red); padding: 15px; background: rgba(138, 0, 0, 0.1); margin-top: 20px;">
            <h3 style="color: var(--accent-red-bright); margin-top: 0;">СТАТУС: КРИТИЧЕСКИЙ</h3>
            <p>До выброса осталось менее 24 часов. Шлюзы будут заблокированы ровно в полночь.</p>
        </div>
        <br><button class="action-btn" onclick="nav('register')">ЗАЯВКА НА УКРЫТИЕ</button>
    </section>

    <section id="register" class="page">
        <h1>ФОРМА РЕГИСТРАЦИИ</h1>
        <div class="cyber-form">
            <form id="bunkerForm" oninput="calcPrice()" onsubmit="submitForm(event)">
                <div class="form-group"><label>ИМЯ / ПОЗЫВНОЙ:</label><input type="text" id="regName" required placeholder="Введите имя..."></div>
                <div class="form-group"><label>ГРУППА КРОВИ:</label><select id="regBlood"><option>O (I)</option><option>A (II)</option><option>B (III)</option><option>AB (IV)</option><option style="color:red">Гороховая (Мутация)</option></select></div>
                <div class="form-group" style="border: 2px solid red; padding: 15px; margin: 20px 0;"><label style="color: var(--accent-red-bright); font-weight: bold; font-size: 1rem;">КОНТРОЛЬНЫЙ ВОПРОС: Употребляли ли вы бобовые за 24 часа?</label><div class="radio-group"><label><input type="radio" name="beans" value="yes"> ДА</label><label><input type="radio" name="beans" value="no" checked> НЕТ</label></div></div>
                <div class="form-group"><label>ВЫ ЭДУАРД?</label><div class="radio-group"><label><input type="radio" name="eduard" value="yes"> ДА</label><label><input type="radio" name="eduard" value="no" checked> НЕТ</label></div></div>
                <div class="form-group"><label>ВЫ ЗЛОБИН?</label><div class="radio-group"><label><input type="radio" name="zlobin" value="yes"> ДА</label><label><input type="radio" name="zlobin" value="no" checked> НЕТ</label></div></div>
                <div class="form-group"><label>ЭТАЖ:</label><select id="floorLevel"><option value="1">-1 Этаж (Рискованно)</option><option value="2">-2 Этаж</option><option value="3">-3 Этаж</option><option value="4">-4 Этаж</option><option value="5" selected>-5 Этаж (Стандарт)</option><option value="6">-6 Этаж</option><option value="7">-7 Этаж</option><option value="8">-8 Этаж</option><option value="9">-9 Этаж</option><option value="10">-10 Этаж (Макс. защита)</option></select></div>
                <div class="form-group"><label>РАСПОЛОЖЕНИЕ:</label><select id="roomLoc"><option value="-100">У параши (Эконом)</option><option value="0" selected>В конце коридора</option><option value="200">Возле входа (Охрана)</option><option value="5000">VIP сектор</option><option value="10000">Гриффинская мафия (Люкс)</option></select></div>
                <div class="form-group"><label>ПРИЧИНА:</label><textarea id="regReason"></textarea></div>
                <div class="price-display">ЦЕНА: <span id="totalPrice">0</span> $</div>
                <button type="submit" class="action-btn">ПОДАТЬ ЗАЯВЛЕНИЕ</button>
            </form>
        </div>
    </section>

    <section id="profile" class="page">
        <h1>ЛИЧНЫЙ КАБИНЕТ</h1>
        <div id="profileContent"></div>
    </section>

    <section id="comments" class="page">
        <h1>ГЛОБАЛЬНЫЙ КАНАЛ СВЯЗИ</h1>
        <div class="cyber-form" style="position: sticky; top: 0; z-index: 500;">
            <textarea id="commentInput" rows="2" placeholder="Сообщение всем выжившим..."></textarea>
            <button onclick="addComment()" class="action-btn" style="margin-top: 10px; font-size: 1rem;">ОТПРАВИТЬ В ЭФИР</button>
        </div>
        <div class="comments-section" id="commentsList">
            <div style="text-align: center; color: #555; padding: 20px;">ЗАГРУЗКА ИЗ CLOUD FIRESTORE...</div>
        </div>
    </section>
</main>

<div id="sound-toggle" onclick="toggleMute()">[ SOUND: OFF ]</div>
<div id="lockdown-overlay"><div class="denied-text">ДОПУСК ВОСПРЕЩЁН</div><h2 style="color: white; margin-top: 20px;">ГЕРМЕТИЗАЦИЯ БУНКЕРА ЗАВЕРШЕНА</h2></div>
<div id="infoModal" class="modal-overlay" onclick="closeModal(event)"><div class="modal-box"><h2 style="color: var(--accent-yellow);">ДОСЬЕ ГРАЖДАНИНА</h2><div id="modalData"></div><br><button class="action-btn" onclick="document.getElementById('infoModal').style.display='none'">ЗАКРЫТЬ</button></div></div>

<script>
    // ===============================================
    // КОНФИГУРАЦИЯ FIRESTORE (ИЗ СКРИНШОТА)
    // ===============================================
    const firebaseConfig = {
      apiKey: "AIzaSyAf-02CWrmdQJPPnGRnrpCapcjzGJNbjJo",
      authDomain: "bunker644-6594b.firebaseapp.com",
      databaseURL: "https://bunker644-6594b-default-rtdb.firebaseio.com",
      projectId: "bunker644-6594b",
      storageBucket: "bunker644-6594b.firebasestorage.app",
      messagingSenderId: "860515978962",
      appId: "1:860515978962:web:aa9dafb0e5468887c1270b",
      measurementId: "G-CSRHYBD4CK"
    };

    // Инициализация
    let db = null;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        document.getElementById('connectionStatus').innerText = "ОНЛАЙН (FIRESTORE)";
        document.getElementById('connectionStatus').style.color = "#00ff00";
    } catch (e) {
        console.error(e);
        document.getElementById('connectionStatus').innerText = "ОШИБКА ПОДКЛЮЧЕНИЯ";
        document.getElementById('connectionStatus').style.color = "red";
    }

    // --- AUDIO SYSTEM ---
    let audioCtx, isMuted = true, sirenOsc, sirenLFO, doomsdayTriggered = false;
    function initAudio() { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); toggleMute(); scheduleGeiger(); } else if (audioCtx.state === 'suspended') audioCtx.resume(); }
    function toggleMute() { isMuted = !isMuted; const btn = document.getElementById('sound-toggle'); btn.innerText = isMuted ? "[ SOUND: OFF ]" : "[ SOUND: ON ]"; btn.style.color = isMuted ? "#555" : "var(--accent-red-bright)"; if(isMuted){ if(audioCtx) audioCtx.suspend(); if(sirenOsc) stopSiren(); } else { if(audioCtx) audioCtx.resume(); if(doomsdayTriggered) startSiren(); } }
    function playMessageSound() { if (isMuted || !audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.frequency.setValueAtTime(800, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(400, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + 0.1); }
    function startSiren() { if(isMuted || !audioCtx) return; sirenOsc = audioCtx.createOscillator(); sirenOsc.type = 'sawtooth'; sirenLFO = audioCtx.createOscillator(); sirenLFO.type = 'sine'; sirenLFO.frequency.value = 0.1; const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 300; const masterGain = audioCtx.createGain(); masterGain.gain.value = 0.3; sirenLFO.connect(lfoGain); lfoGain.connect(sirenOsc.frequency); sirenOsc.connect(masterGain); masterGain.connect(audioCtx.destination); sirenOsc.frequency.value = 600; sirenOsc.start(); sirenLFO.start(); }
    function stopSiren() { if(sirenOsc) { sirenOsc.stop(); sirenOsc = null; } }
    function playGeigerClick() { if(isMuted || !audioCtx || doomsdayTriggered) return; const buf = audioCtx.createBuffer(1, audioCtx.sampleRate*0.01, audioCtx.sampleRate); const d = buf.getChannelData(0); for(let i=0; i<d.length; i++) d[i]=Math.random()*2-1; const n = audioCtx.createBufferSource(); n.buffer=buf; const g = audioCtx.createGain(); g.gain.value=0.2; n.connect(g); g.connect(audioCtx.destination); n.start(); }
    function scheduleGeiger() { setTimeout(() => { playGeigerClick(); scheduleGeiger(); }, Math.random()*500+200); }

    // --- LOGIC ---
    let currentUser = JSON.parse(localStorage.getItem('bunker_user_v8'));

    // --- ИСПРАВЛЕННАЯ ЛОГИКА ЧАТА ---
    function initChat() {
        if (!db) return;
        const list = document.getElementById('commentsList');

        db.collection("comments")
          .orderBy("timestamp", "asc") 
          .onSnapshot((snapshot) => {
              if(list.innerText.includes("ЗАГРУЗКА")) list.innerHTML = "";
              
              if (snapshot.empty) {
                  list.innerHTML = "<div id='emptyMsg' style='text-align: center; color: #555; padding: 20px;'>КАНАЛ ПУСТ. ОТПРАВЬТЕ СООБЩЕНИЕ.</div>";
              }

              snapshot.docChanges().forEach((change) => {
                  if (change.type === "added") {
                      const emptyMsg = document.getElementById('emptyMsg');
                      if(emptyMsg) emptyMsg.remove();

                      const data = change.doc.data();
                      renderSingleComment(data);
                      
                      if (data.name !== (currentUser ? currentUser.name : "Гость")) {
                          playMessageSound();
                      }
                  }
              });
          }, (error) => {
              console.error(error);
              if (error.code === 'failed-precondition') {
                  list.innerHTML = "<div style='color:orange; text-align:center'>НУЖЕН ИНДЕКС. ПРОВЕРЬТЕ КОНСОЛЬ БРАУЗЕРА (F12).</div>";
              } else {
                  list.innerHTML = "<div style='color:red; text-align:center'>ОШИБКА: " + error.message + "</div>";
              }
          });
    }

    function addComment() {
        if (!db) return;
        const input = document.getElementById('commentInput');
        const txt = input.value.trim();
        if (!txt) return;

        const newComment = {
            name: currentUser ? currentUser.name : "Гость",
            text: txt,
            room: currentUser ? currentUser.roomNum : null,
            floor: currentUser ? currentUser.floor : null,
            roomName: currentUser ? currentUser.roomName : null,
            blood: currentUser ? currentUser.blood : null,
            beans: currentUser ? currentUser.beans : null,
            cost: currentUser ? currentUser.cost : null,
            reason: currentUser ? currentUser.reason : null,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        db.collection("comments").add(newComment)
          .then(() => { input.value = ""; })
          .catch((err) => { alert("Сбой передачи: " + err.message); });
    }

    function renderSingleComment(c) {
        const list = document.getElementById('commentsList');
        const div = document.createElement('div'); 
        div.className = 'comment';
        
        const dataForModal = {
            name: c.name, roomNum: c.room, floor: c.floor, 
            roomName: c.roomName, blood: c.blood, 
            beans: c.beans, cost: c.cost, reason: c.reason
        };
        const dataStr = encodeURIComponent(JSON.stringify(dataForModal));
        
        let badgeHtml = c.room ? `<span class="user-badge" onclick="showUserModal('${dataStr}')">#${c.room}</span>` : "";
        const safeText = c.text ? c.text.replace(/</g, "&lt;") : "";
        const safeName = c.name ? c.name.replace(/</g, "&lt;") : "Unknown";
        
        div.innerHTML = `<div class="comment-header"><span style="font-weight:bold; color:#fff;">${safeName}</span>${badgeHtml}</div><div class="comment-text">${safeText}</div>`;
        list.insertBefore(div, list.firstChild);
    }

    // --- ОСТАЛЬНЫЕ ФУНКЦИИ ---
    function nav(pageId) {
        if (doomsdayTriggered) return;
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        if(pageId === 'profile') renderProfile();
    }

    function updateTimer() {
        const target = new Date('December 19, 2025 00:00:00').getTime();
        const now = new Date().getTime();
        const diff = target - now;
        let progress = 100 - (diff / (1000 * 60 * 60 * 48) * 100);
        if (diff <= 0) {
            progress = 100;
            const timerEl = document.getElementById('timer');
            timerEl.innerHTML = "!!! ВРЕМЯ ВЫШЛО !!!"; timerEl.style.color = "red"; timerEl.style.animation = "panic-blink 0.2s infinite";
            if (!doomsdayTriggered) triggerDoomsday();
        } else {
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('timer').innerText = (h<10?"0"+h:h)+":"+(m<10?"0"+m:m)+":"+(s<10?"0"+s:s);
        }
        const meter = document.getElementById('meter-fill');
        if(meter) meter.style.width = progress + '%';
        const percent = document.getElementById('threat-percent');
        if(percent) percent.innerText = Math.floor(progress) + '%';
    }

    function triggerDoomsday() {
        doomsdayTriggered = true;
        document.body.classList.add('doomsday-active');
        document.querySelectorAll('input, select, textarea, button').forEach(el => { el.disabled = true; el.style.borderColor = "red"; });
        startSiren();
        setTimeout(() => document.getElementById('lockdown-overlay').style.display = 'flex', 1000);
    }
    setInterval(updateTimer, 1000);

    function calcPrice() {
        const floor = parseInt(document.getElementById('floorLevel').value);
        const locPrice = parseInt(document.getElementById('roomLoc').value);
        const isEduard = document.querySelector('input[name="eduard"]:checked').value === 'yes';
        const isZlobin = document.querySelector('input[name="zlobin"]:checked').value === 'yes';
        let total = 1000 + (floor * 500) + locPrice;
        if (isEduard && isZlobin) total = total * 5 + 666; else if (isEduard || isZlobin) total += 500;
        document.getElementById('totalPrice').innerText = total;
    }

    function submitForm(e) {
        e.preventDefault();
        const name = document.getElementById('regName').value;
        const blood = document.getElementById('regBlood').value;
        const beans = document.querySelector('input[name="beans"]:checked').value;
        const floor = document.getElementById('floorLevel').value;
        const roomName = document.getElementById('roomLoc').options[document.getElementById('roomLoc').selectedIndex].text;
        const reason = document.getElementById('regReason').value;
        const cost = document.getElementById('totalPrice').innerText;
        const roomNum = floor + "" + Math.floor(Math.random() * 899 + 100);
        
        currentUser = { name, blood, beans, floor, roomName, roomNum, cost, reason };
        localStorage.setItem('bunker_user_v8', JSON.stringify(currentUser));
        alert("ОДОБРЕНО. КОМНАТА #" + roomNum);
        nav('profile');
    }

    function renderProfile() {
        const c = document.getElementById('profileContent');
        if(!currentUser) { c.innerHTML = "<center>НЕТ ДАННЫХ. ЗАПОЛНИТЕ ЗАЯВКУ.</center>"; return; }
        c.innerHTML = `
        <div class="profile-card">
            <h2 style="color:var(--accent-red-bright); border-bottom:1px solid #333">КАРТА РЕЗИДЕНТА #${currentUser.roomNum}</h2>
            <div class="data-row"><span>ИМЯ:</span> <span>${currentUser.name}</span></div>
            <div class="data-row"><span>ГРУППА КРОВИ:</span> <span>${currentUser.blood}</span></div>
            <div class="data-row"><span>СТАТУС БОБОВЫХ:</span> <span style="color:${currentUser.beans==='yes'?'red':'green'}">${currentUser.beans==='yes'?'ЗАРАЖЕН':'ЧИСТ'}</span></div>
            <div class="data-row"><span>ЭТАЖ:</span> <span>-${currentUser.floor}</span></div>
            <div class="data-row"><span>ТИП КОМНАТЫ:</span> <span>${currentUser.roomName}</span></div>
            <div class="data-row"><span>СТОИМОСТЬ:</span> <span>$${currentUser.cost}</span></div>
            <div class="data-row" style="display:block; margin-top:10px;"><span style="color:#777; font-size:0.8rem">ПРИЧИНА:</span><br><span style="font-style:italic; color:#ccc">${currentUser.reason}</span></div>
        </div>`;
    }

    window.showUserModal = function(dataStr) {
        if(doomsdayTriggered || !dataStr) return;
        const data = JSON.parse(decodeURIComponent(dataStr));
        const modal = document.getElementById('infoModal');
        document.getElementById('modalData').innerHTML = `
            <p><strong>ИМЯ:</strong> ${data.name}</p>
            <p><strong>КОМНАТА:</strong> #${data.roomNum}</p>
            <p><strong>ЭТАЖ:</strong> -${data.floor}</p>
            <p><strong>ТИП:</strong> ${data.roomName}</p>
            <p><strong>КРОВЬ:</strong> ${data.blood}</p>
            <p><strong>БОБОВЫЕ:</strong> ${data.beans==='yes'?'<span style="color:red">ОПАСЕН</span>':'<span style="color:green">ЧИСТ</span>'}</p>
            <p><strong>ЦЕНА СПАСЕНИЯ:</strong> $${data.cost}</p>
            <hr style="border:0; border-top:1px dashed #333; margin:10px 0;">
            <p style="font-size:0.8rem; color:#888;">"${data.reason || 'Нет данных'}"</p>
        `;
        modal.style.display = 'flex';
    }
    
    function closeModal(e) { if (e.target.id === 'infoModal') document.getElementById('infoModal').style.display = 'none'; }

    updateTimer();
    calcPrice();
    initChat();
</script>
</body>
</html>
